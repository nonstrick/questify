from django.shortcuts import render, redirect
from django.contrib.auth import login, logout
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.http import JsonResponse
from django.views.decorators.http import require_http_methods
from django.views.decorators.csrf import csrf_exempt
import json
import re
from .forms import RegisterForm, LoginForm
from .gigachat_client import GigaChatClient


def home(request):
    return render(request, 'home/index.html')


def register_view(request):
    if request.user.is_authenticated:
        return redirect('profile')
    
    if request.method == 'POST':
        form = RegisterForm(request.POST)
        if form.is_valid():
            user = form.save()
            login(request, user)
            messages.success(request, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!')
            return redirect('profile')
    else:
        form = RegisterForm()
    
    return render(request, 'home/register.html', {'form': form})


def login_view(request):
    if request.user.is_authenticated:
        return redirect('profile')
    
    if request.method == 'POST':
        form = LoginForm(data=request.POST)
        if form.is_valid():
            user = form.get_user()
            login(request, user)
            messages.success(request, f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.username}!')
            return redirect('profile')
    else:
        form = LoginForm()
    
    return render(request, 'home/login.html', {'form': form})


@login_required
def logout_view(request):
    logout(request)
    messages.info(request, '–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.')
    return redirect('home')


@login_required
def profile_view(request):
    return render(request, 'home/profile.html', {'user': request.user})


def about_view(request):
    return render(request, 'home/about.html')


@login_required
def test_view(request):
    if 'test_messages' not in request.session:
        request.session['test_messages'] = []
        request.session['test_stage'] = 'collecting'
        request.session['collected_data'] = {
            'interests': '',
            'skills': '',
            'budget': '',
            'time': '',
            'location': ''
        }
    
    return render(request, 'home/test.html')


@login_required
@require_http_methods(["POST"])
def test_chat_view(request):
    try:
        data = json.loads(request.body)
        user_message = data.get('message', '').strip()
        
        if not user_message:
            return JsonResponse({'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'}, status=400)
        
        if 'test_messages' not in request.session:
            request.session['test_messages'] = []
            request.session['test_stage'] = 'collecting'
            request.session['collected_data'] = {
                'interests': '',
                'skills': '',
                'budget': '',
                'time': '',
                'location': ''
            }
        
        messages_history = request.session['test_messages']
        stage = request.session['test_stage']
        collected_data = request.session['collected_data']
        
        messages_history.append({'role': 'user', 'content': user_message})
        
        client = GigaChatClient()
        
        if stage == 'collecting':
            system_prompt = """–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤–Ω—É—Ç—Ä–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ¬´–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π –¥–ª—è —Ö–æ–±–±–∏ –∏ —É–≤–ª–µ—á–µ–Ω–∏–π¬ª. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ —Ö–æ–±–±–∏ –∏ —É–≤–ª–µ—á–µ–Ω–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–¥ –µ–≥–æ –ª–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

1. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –æ–±—â–∞–π—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ, –∏–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –ª—ë–≥–∫–∏–π –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ç–æ–Ω. 

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ —Å–º–∞–π–ª–∏–∫–∏ (üòä, üòÑ, –∏ —Ç.–¥.) –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
- –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–°–ø–∞—Å–∏–±–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞ –æ—Ç–≤–µ—Ç!" –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤
- –í–°–ï–ì–î–ê –ø–∏—à–∏ –ø–æ–ª–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏–ª–∏ –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ - 50 —Å–∏–º–≤–æ–ª–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–µ —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏)
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å—ã –æ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö, –≤—Ä–µ–º–µ–Ω–∏, –±—é–¥–∂–µ—Ç–µ –∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏

–í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–±—è –∏–ª–∏ –ø–∏—à–µ—Ç —á—Ç–æ-—Ç–æ –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–∏–≤–µ—Ç, –º–æ–π –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥"), –æ—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–æ –Ω–µ –∑–∞–¥–∞–≤–∞–π —Å—Ä–∞–∑—É —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ —Å–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö.

2. –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

 ‚Ä¢ –í–ê–ñ–ù–û: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ª—é–±–ª—é —Ü–≤–µ—Ç—ã" –∏–ª–∏ "–æ—á–µ–Ω—å –ª—é–±–ª—é –∂–∏–≤–æ–ø–∏—Å—å"), —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã!

 ‚Ä¢ –°–æ–±–∏—Ä–∞–π –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, —É–∂–µ –∏–º–µ—é—â–∏–µ—Å—è –Ω–∞–≤—ã–∫–∏, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–Ω—è—Ç–∏–π, –±—é–¥–∂–µ—Ç (–Ω–∏–∑–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π, –≤—ã—Å–æ–∫–∏–π –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—É–º–º–∞), –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.

 ‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –∫–æ—Ä–æ—Ç–∫–æ –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω–æ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã. –ù–∞–ø—Ä–∏–º–µ—Ä: "–û—Ç–ª–∏—á–Ω–æ! –ê —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—ã –≥–æ—Ç–æ–≤ —É–¥–µ–ª—è—Ç—å —ç—Ç–æ–º—É –∑–∞–Ω—è—Ç–∏—é? –ö–∞–∫–æ–π —É —Ç–µ–±—è –±—é–¥–∂–µ—Ç? –ì–¥–µ —Ç—ã –∂–∏–≤–µ—à—å?"

 ‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∫–∞–∑–∞–ª: –∏–Ω—Ç–µ—Ä–µ—Å—ã/–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, –≤—Ä–µ–º—è, –±—é–¥–∂–µ—Ç –∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤—Å—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ–±—Ä–∞–Ω–∞!

 ‚Ä¢ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ 2-3 –ø–æ–ø—ã—Ç–æ–∫ - –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ—é—â–µ–π—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

3. –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Å–æ–±–µ—Ä–µ—à—å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–∏–Ω—Ç–µ—Ä–µ—Å—ã, –Ω–∞–≤—ã–∫–∏, –≤—Ä–µ–º—è, –±—é–¥–∂–µ—Ç, –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ) –ò–õ–ò –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: "–û—Ç–ª–∏—á–Ω–æ! –Ø —Å–æ–±—Ä–∞–ª –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –°–µ–π—á–∞—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è —Ç–µ–±—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!" –∏ –±–æ–ª—å—à–µ –Ω–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤.

4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ö–æ–±–±–∏ (–æ—Ç 3 –¥–æ 7), —á—Ç–æ–±—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª –≤—ã–±–æ—Ä, –ø–æ–¥–±–∏—Ä–∞–π –∏–¥–µ–∏, –∏—Å—Ö–æ–¥—è –∏–∑ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –±–∞–ª–∞–Ω—Å–∏—Ä—É–π –º–µ–∂–¥—É –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏.

5. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —Ö–æ–±–±–∏

–î–ª—è –∫–∞–∂–¥–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π: –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–Ω–∞—á–∏–Ω–∞—é—â–∏–π / —Å—Ä–µ–¥–Ω–∏–π / –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π), —Å–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º –±—é–¥–∂–µ—Ç–æ–º), —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –æ–±—É—á–µ–Ω–∏—è (–æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ã, –∫–Ω–∏–≥–∏, YouTube-–∫–∞–Ω–∞–ª—ã), –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –æ–¥–Ω–æ–º—É –∏–ª–∏ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ, –∫–ª—É–±—ã/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ).

6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è: —É—á–∏—Ç—ã–≤–∞–π —Ç—Ä–µ–Ω–¥—ã –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —É–≤–ª–µ—á–µ–Ω–∏—è, –Ω–æ –Ω–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ —Ä–µ–¥–∫–∏–µ –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∏–¥–µ–∏, –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã, –∫–∞–∫ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Ö–æ–±–±–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–æ—Å–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏—é."""
            
            user_messages_count = sum(1 for msg in messages_history if msg['role'] == 'user')
            assistant_messages_count = sum(1 for msg in messages_history if msg['role'] == 'assistant')
            
            initial_message = {
                'role': 'assistant',
                'content': '–ü—Ä–∏–≤–µ—Ç! –†–∞–¥–∞ –∑–Ω–∞–∫–æ–º—Å—Ç–≤—É! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ: –∫–∞–∫–∏–µ —É —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è? –ß–µ–º —É–≤–ª–µ–∫–∞–ª—Å—è —Ä–∞–Ω—å—à–µ? –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–∂–µ—à—å —É–¥–µ–ª—è—Ç—å –Ω–æ–≤–æ–º—É –∑–∞–Ω—è—Ç–∏—é –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é? –ö–∞–∫–æ–π —É —Ç–µ–±—è –±—é–¥–∂–µ—Ç –Ω–∞ –Ω–æ–≤–æ–µ —Ö–æ–±–±–∏ - –Ω–∏–∑–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π –∏–ª–∏ –≤—ã—Å–æ–∫–∏–π? –†–∞—Å—Å–∫–∞–∂–µ—à—å –µ—â—ë, –≥–¥–µ –∂–∏–≤—ë—à—å? –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ–±—è.'
            }
            
            if user_messages_count == 1 and assistant_messages_count == 0:
                messages_history.insert(0, initial_message)
                request.session['test_messages'] = messages_history
                
                chat_messages = [
                    {'role': 'system', 'content': system_prompt},
                    initial_message,
                    {'role': 'user', 'content': user_message}
                ]
                
                response_text = client.get_response_text(chat_messages, temperature=0.7)
                
                if response_text:
                    response_text = response_text.replace('###', '').replace('**', '').replace('__', '').replace('---', '').replace('***', '')
                    response_text = re.sub(r'\*\*(.*?)\*\*', r'\1', response_text)
                    response_text = re.sub(r'__(.*?)__', r'\1', response_text)
                    
                    response_clean = response_text.strip()
                    has_letters = any(char.isalpha() for char in response_clean if ord(char) < 128)
                    is_only_emoji_or_short = (
                        not response_text or 
                        len(response_clean) < 50 or 
                        (len(response_clean) < 100 and not has_letters) or
                        (len(response_clean) < 30) or
                        (len([c for c in response_clean if c.isalpha()]) < 20)
                    )
                    if is_only_emoji_or_short:
                        response_text = initial_message['content']
                
                messages_history.append({'role': 'assistant', 'content': response_text})
                request.session['test_messages'] = messages_history
                
                return JsonResponse({
                    'message': response_text,
                    'stage': stage
                })
            
            chat_messages = [
                {'role': 'system', 'content': system_prompt}
            ] + messages_history
            
            response_text = client.get_response_text(chat_messages, temperature=0.7)
            
            if response_text:
                response_text = response_text.replace('###', '').replace('**', '').replace('__', '').replace('---', '').replace('***', '')
                response_text = re.sub(r'\*\*(.*?)\*\*', r'\1', response_text)
                response_text = re.sub(r'__(.*?)__', r'\1', response_text)
                
                last_user_msg = next((msg['content'] for msg in reversed(messages_history) if msg['role'] == 'user'), '')
                last_user_lower = last_user_msg.lower()
                
                is_greeting_or_casual = any(word in last_user_lower for word in ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä—ã–π', '–¥–æ–±—Ä–æ–µ', '–¥–æ–±—Ä–æ–π', '–¥–æ–±—Ä–æ–≥–æ', '–¥–æ–±—Ä—ã–π –¥–µ–Ω—å', '–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä', '–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ', '–¥–æ—Ä–æ–≥–æ–π', '–¥—Ä—É–≥', '–¥—Ä—É–∑—å—è', '–∫–∞–∫ –¥–µ–ª–∞', '–∫–∞–∫ –ø–æ–∂–∏–≤–∞–µ—à—å'])
                
                response_clean = response_text.strip()
                is_only_emoji = len(response_clean) < 30 and not any(char.isalpha() for char in response_clean if ord(char) < 128)
                
                if is_only_emoji or (len(response_clean) < 20 and '?' not in response_clean and '–ø–æ–¥–≥–æ—Ç–æ–≤–ª—é' not in response_clean.lower()):
                    if user_messages_count == 1:
                        response_text = "–ü—Ä–∏–≤–µ—Ç! –†–∞–¥–∞ –∑–Ω–∞–∫–æ–º—Å—Ç–≤—É! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ: –∫–∞–∫–∏–µ —É —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è? –ß–µ–º —É–≤–ª–µ–∫–∞–ª—Å—è —Ä–∞–Ω—å—à–µ? –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–∂–µ—à—å —É–¥–µ–ª—è—Ç—å –Ω–æ–≤–æ–º—É –∑–∞–Ω—è—Ç–∏—é –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é? –ö–∞–∫–æ–π —É —Ç–µ–±—è –±—é–¥–∂–µ—Ç –Ω–∞ –Ω–æ–≤–æ–µ —Ö–æ–±–±–∏ - –Ω–∏–∑–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π –∏–ª–∏ –≤—ã—Å–æ–∫–∏–π? –†–∞—Å—Å–∫–∞–∂–µ—à—å –µ—â—ë, –≥–¥–µ –∂–∏–≤—ë—à—å? –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ–±—è."
                    else:
                        has_interest_keywords = any(word in last_user_lower for word in ['–ª—é–±–ª—é', '–Ω—Ä–∞–≤–∏—Ç—Å—è', '–∏–Ω—Ç–µ—Ä–µ—Å', '—É–≤–ª–µ–∫–∞—é—Å—å', '—É–≤–ª–µ–∫–∞–ª—Å—è', '—Ö–æ—á—É', '—Ö–æ—Ç–µ–ª', '–Ω—Ä–∞–≤—è—Ç—Å—è', '–Ω—Ä–∞–≤–∏—Ç—å—Å—è'])
                        if has_interest_keywords and len(last_user_msg.split()) < 10:
                            response_text = f"–û—Ç–ª–∏—á–Ω–æ! –ê —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—ã –≥–æ—Ç–æ–≤ —É–¥–µ–ª—è—Ç—å —ç—Ç–æ–º—É –∑–∞–Ω—è—Ç–∏—é? –ö–∞–∫–æ–π —É —Ç–µ–±—è –±—é–¥–∂–µ—Ç –Ω–∞ –Ω–æ–≤–æ–µ —Ö–æ–±–±–∏ - –Ω–∏–∑–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π –∏–ª–∏ –≤—ã—Å–æ–∫–∏–π? –ò –≥–¥–µ —Ç—ã –∂–∏–≤–µ—à—å? –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ–±—è."
                        elif has_all_info:
                            response_text = "–û—Ç–ª–∏—á–Ω–æ! –Ø —Å–æ–±—Ä–∞–ª –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –°–µ–π—á–∞—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è —Ç–µ–±—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!"
                        else:
                            response_text = "–†–∞—Å—Å–∫–∞–∂–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ —Å–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å –¥–ª—è —Ç–µ–±—è –∏–¥–µ–∞–ª—å–Ω—ã–µ —Ö–æ–±–±–∏!"
            
            last_user_message = next((msg['content'] for msg in reversed(messages_history) if msg['role'] == 'user'), '')
            
            user_messages_count = sum(1 for msg in messages_history if msg['role'] == 'user')
            assistant_questions_count = sum(1 for msg in messages_history if msg['role'] == 'assistant' and '?' in msg.get('content', ''))
            
            all_messages_text = ' '.join([msg.get('content', '') for msg in messages_history if msg['role'] == 'user'])
            
            has_all_info = (
                any(word in all_messages_text.lower() for word in ['–∏–Ω—Ç–µ—Ä–µ—Å', '—É–≤–ª–µ–∫–∞–ª', '–Ω—Ä–∞–≤–∏—Ç—Å—è', '–ª—é–±–ª—é', '–º—É–±–ª—é', '–º—É–∑—ã–∫', '—Å–ø–æ—Ä—Ç', '—Ç–≤–æ—Ä—á', '–ø—Ä–∏—Ä–æ–¥', '—Ç–µ—Ö–Ω–æ–ª–æ–≥', '—á–∏—Ç–∞—Ç', '—Ä–∏—Å–æ–≤–∞–Ω', '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ', '—Ü–≤–µ—Ç', '–∂–∏–≤–æ–ø–∏—Å']) and
                any(word in all_messages_text.lower() for word in ['—á–∞—Å', '–≤—Ä–µ–º—è', '–º–∏–Ω—É—Ç', '–¥–µ–Ω—å', '–Ω–µ–¥–µ–ª', '3', '—Ç—Ä–∏', '–¥–≤–∞', '—á–µ—Ç—ã—Ä–µ', '–ø—è—Ç—å', '–Ω–µ—Å–∫–æ–ª—å–∫–æ']) and
                any(word in all_messages_text.lower() for word in ['–±—é–¥–∂–µ—Ç', '—Ä—É–±–ª', '—Ç—ã—Å', '—Ç—ã—Å—è—á', '10', '–Ω–∏–∑–∫', '—Å—Ä–µ–¥–Ω', '–≤—ã—Å–æ–∫', '–¥–µ—à–µ–≤', '–¥–æ—Ä–æ–≥']) and
                any(word in all_messages_text.lower() for word in ['–∂–∏–≤—É', '–≥–æ—Ä–æ–¥', '–∫–∞–∑–∞–Ω', '–º–æ—Å–∫–≤', '—Å–ø–±', '–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω', '–∞–¥—Ä–µ—Å', '—Ä–µ–≥–∏–æ–Ω', '–æ–±–ª–∞—Å—Ç'])
            )
            
            is_short_answer = len(last_user_message.split()) < 8
            
            if response_text and "–ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è —Ç–µ–±—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" in response_text.lower():
                should_generate = True
            elif has_all_info and user_messages_count >= 2:
                should_generate = True
            elif user_messages_count >= 3 and assistant_questions_count >= 2:
                should_generate = True
            else:
                should_generate = False
            
            
            if should_generate:
                if "–ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è —Ç–µ–±—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" not in response_text.lower():
                    response_text = "–û—Ç–ª–∏—á–Ω–æ! –Ø —Å–æ–±—Ä–∞–ª –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –°–µ–π—á–∞—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è —Ç–µ–±—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!"
                
                extract_prompt = """–ù–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∏–∑–≤–ª–µ–∫–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "interests": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
  "skills": "–Ω–∞–≤—ã–∫–∏ –∏ —É–º–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–º–∏ –æ–±–ª–∞–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
  "budget": "–Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—É–º–º–∞",
  "time": "—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–∂–µ—Ç —É–¥–µ–ª—è—Ç—å —Ö–æ–±–±–∏",
  "location": "–≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ —Ç–∏–ø –º–µ—Å—Ç–Ω–æ—Å—Ç–∏"
}

–ï—Å–ª–∏ –∫–∞–∫–∞—è-—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ —É–∫–∞–∑–∞–Ω–∞, —É–∫–∞–∂–∏ "–Ω–µ —É–∫–∞–∑–∞–Ω–æ". –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""
                
                extract_messages = [
                    {'role': 'system', 'content': extract_prompt},
                    {'role': 'user', 'content': '–ò–∑–≤–ª–µ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞:\n\n' + '\n'.join([f"{msg['role']}: {msg['content']}" for msg in messages_history])}
                ]
                
                try:
                    extracted_json = client.get_response_text(extract_messages, temperature=0.3)
                    json_match = re.search(r'\{[^}]+\}', extracted_json, re.DOTALL)
                    if json_match:
                        extracted_data = json.loads(json_match.group())
                        collected_data.update(extracted_data)
                        request.session['collected_data'] = collected_data
                except:
                    pass
                
                stage = 'generating'
                request.session['test_stage'] = 'generating'
                request.session['test_messages'] = messages_history
                
                full_conversation = '\n'.join([f"{msg['role']}: {msg['content']}" for msg in messages_history if msg['role'] != 'system'])
                
                interests = collected_data.get('interests', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
                skills = collected_data.get('skills', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
                budget = collected_data.get('budget', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
                time = collected_data.get('time', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
                location = collected_data.get('location', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
                
                system_prompt = f"""–¢—ã ‚Äì –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π –¥–ª—è —Ö–æ–±–±–∏ –∏ —É–≤–ª–µ—á–µ–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ—Å–∫–æ–ª—å–∫–æ (3‚Äì7) –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ö–æ–±–±–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ### (—Ç—Ä–∏ —Ä–µ—à–µ—Ç–∫–∏)
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ** (–¥–≤–µ –∑–≤–µ–∑–¥–æ—á–∫–∏) –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã __ (–¥–≤–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ "---" –∏–ª–∏ "***"
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–æ–±—â–µ
‚úÖ –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û: –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, —ç–º–æ–¥–∑–∏, –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫, –¥–≤–æ–µ—Ç–æ—á–∏—è

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï –ö –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø–ú:
- –í–°–ï —Ö–æ–±–±–∏ –î–û–õ–ñ–ù–´ –±—ã—Ç—å –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω—ã —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–ª–µ—Ç–∞—Ç—å" - –ø—Ä–µ–¥–ª–∞–≥–∞–π –¢–û–õ–¨–ö–û —Ö–æ–±–±–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–æ–ª–µ—Ç–∞–º–∏ (–ø–∞—Ä–∞–ø–ª–∞–Ω–µ—Ä–∏–∑–º, –¥–µ–ª—å—Ç–∞–ø–ª–∞–Ω–µ—Ä–∏–∑–º, –∞–≤–∏–∞–º–æ–¥–µ–ª–∏–∑–º, –ø–∞—Ä–∞—à—é—Ç–Ω—ã–π —Å–ø–æ—Ä—Ç –∏ —Ç.–¥.)
- –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ö–æ–±–±–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Å–≤—è–∑–∞–Ω—ã —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–ª–µ—Ç–∞—Ç—å", –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤—ã—à–∏–≤–∫—É –∏–ª–∏ –∏–≥—Ä—É –Ω–∞ —É–∫—É–ª–µ–ª–µ)
- –í—Å–µ —Ö–æ–±–±–∏ –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤—ã—Ç–µ–∫–∞—Ç—å –∏–∑ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ–±–±–∏:

[–≠–º–æ–¥–∑–∏ —Ö–æ–±–±–∏] –ù–∞–∑–≤–∞–Ω–∏–µ —Ö–æ–±–±–∏

üìù –û–ø–∏—Å–∞–Ω–∏–µ: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–æ—á–µ–º—É –æ–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏ —Å–≤—è–∑—å —Å –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏

‚öôÔ∏è –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: –Ω–∞—á–∏–Ω–∞—é—â–∏–π / —Å—Ä–µ–¥–Ω–∏–π / –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π

üí∞ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: —Å–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º –±—é–¥–∂–µ—Ç–æ–º

üìö –û–±—É—á–µ–Ω–∏–µ: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (–æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, –∫–Ω–∏–≥–∏, YouTube-–∫–∞–Ω–∞–ª—ã)

üë• –§–æ—Ä–º–∞—Ç: –º–æ–∂–Ω–æ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –æ–¥–Ω–æ–º—É –∏–ª–∏ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ

üè¢ –ö–ª—É–±—ã: –∫–ª—É–±—ã/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, —É—á–∏—Ç—ã–≤–∞—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {location})


–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–∏–∞–ª–æ–≥–∞:

–ò–Ω—Ç–µ—Ä–µ—Å—ã: {interests}
–ù–∞–≤—ã–∫–∏: {skills}
–ë—é–¥–∂–µ—Ç: {budget}
–í—Ä–µ–º—è: {time}
–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {location}

–ü–æ–ª–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
{full_conversation}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–ù–∞—á–Ω–∏ —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç–º–æ–¥–∑–∏ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∑–∞—Ç–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ–±–±–∏ —Å–æ–∑–¥–∞–π –±–ª–æ–∫ —Å—Ç—Ä–æ–≥–æ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –≤—ã—à–µ. –ú–µ–∂–¥—É —Ö–æ–±–±–∏ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –∏ —ç–º–æ–¥–∑–∏, –Ω–∏–∫–∞–∫–æ–≥–æ markdown! –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –°–¢–†–û–ì–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
                
                user_interests_summary = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è: {interests}. –í–°–ï —Ö–æ–±–±–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã –∏–º–µ–Ω–Ω–æ —Å —ç—Ç–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–æ–º."
                
                chat_messages = [
                    {'role': 'system', 'content': system_prompt},
                    {'role': 'user', 'content': f'{user_interests_summary}\n\n–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –º–Ω–µ —Å–ø–∏—Å–æ–∫ –∏–∑ 3-7 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ö–æ–±–±–∏, –∫–æ—Ç–æ—Ä—ã–µ –°–¢–†–û–ì–û —Å–≤—è–∑–∞–Ω—ã —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ö–æ–±–±–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º.'}
                ]
                
                recommendations = client.get_response_text(chat_messages, temperature=0.9)
                
                if recommendations:
                    recommendations = recommendations.replace('###', '').replace('**', '').replace('__', '').replace('---', '').replace('***', '')
                    recommendations = re.sub(r'\*\*(.*?)\*\*', r'\1', recommendations)
                    recommendations = re.sub(r'__(.*?)__', r'\1', recommendations)
                
                messages_history.append({'role': 'assistant', 'content': recommendations})
                request.session['test_messages'] = messages_history
                request.session['test_stage'] = 'completed'
                
                return JsonResponse({
                    'message': recommendations,
                    'stage': 'completed'
                })
            
            messages_history.append({'role': 'assistant', 'content': response_text})
            request.session['test_messages'] = messages_history
            
            return JsonResponse({
                'message': response_text,
                'stage': stage
            })
        
        elif stage == 'generating':
            full_conversation = '\n'.join([f"{msg['role']}: {msg['content']}" for msg in messages_history if msg['role'] != 'system'])
            
            interests = collected_data.get('interests', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
            skills = collected_data.get('skills', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
            budget = collected_data.get('budget', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
            time = collected_data.get('time', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
            location = collected_data.get('location', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')
            
            system_prompt = f"""–¢—ã ‚Äì –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π –¥–ª—è —Ö–æ–±–±–∏ –∏ —É–≤–ª–µ—á–µ–Ω–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ—Å–∫–æ–ª—å–∫–æ (3‚Äì7) –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ö–æ–±–±–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ### (—Ç—Ä–∏ —Ä–µ—à–µ—Ç–∫–∏)
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ** (–¥–≤–µ –∑–≤–µ–∑–¥–æ—á–∫–∏) –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã __ (–¥–≤–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ "---" –∏–ª–∏ "***"
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–æ–±—â–µ
‚úÖ –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û: –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, —ç–º–æ–¥–∑–∏, –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫, –¥–≤–æ–µ—Ç–æ—á–∏—è

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï –ö –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø–ú:
- –í–°–ï —Ö–æ–±–±–∏ –î–û–õ–ñ–ù–´ –±—ã—Ç—å –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω—ã —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–ª–µ—Ç–∞—Ç—å" - –ø—Ä–µ–¥–ª–∞–≥–∞–π –¢–û–õ–¨–ö–û —Ö–æ–±–±–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–æ–ª–µ—Ç–∞–º–∏ (–ø–∞—Ä–∞–ø–ª–∞–Ω–µ—Ä–∏–∑–º, –¥–µ–ª—å—Ç–∞–ø–ª–∞–Ω–µ—Ä–∏–∑–º, –∞–≤–∏–∞–º–æ–¥–µ–ª–∏–∑–º, –ø–∞—Ä–∞—à—é—Ç–Ω—ã–π —Å–ø–æ—Ä—Ç –∏ —Ç.–¥.)
- –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ö–æ–±–±–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Å–≤—è–∑–∞–Ω—ã —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–ª–µ—Ç–∞—Ç—å", –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤—ã—à–∏–≤–∫—É –∏–ª–∏ –∏–≥—Ä—É –Ω–∞ —É–∫—É–ª–µ–ª–µ)
- –í—Å–µ —Ö–æ–±–±–∏ –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤—ã—Ç–µ–∫–∞—Ç—å –∏–∑ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ–±–±–∏:

[–≠–º–æ–¥–∑–∏ —Ö–æ–±–±–∏] –ù–∞–∑–≤–∞–Ω–∏–µ —Ö–æ–±–±–∏

üìù –û–ø–∏—Å–∞–Ω–∏–µ: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–æ—á–µ–º—É –æ–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏ —Å–≤—è–∑—å —Å –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏

‚öôÔ∏è –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: –Ω–∞—á–∏–Ω–∞—é—â–∏–π / —Å—Ä–µ–¥–Ω–∏–π / –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π

üí∞ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: —Å–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º –±—é–¥–∂–µ—Ç–æ–º

üìö –û–±—É—á–µ–Ω–∏–µ: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã (–æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, –∫–Ω–∏–≥–∏, YouTube-–∫–∞–Ω–∞–ª—ã)

üë• –§–æ—Ä–º–∞—Ç: –º–æ–∂–Ω–æ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –æ–¥–Ω–æ–º—É –∏–ª–∏ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ

üè¢ –ö–ª—É–±—ã: –∫–ª—É–±—ã/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, —É—á–∏—Ç—ã–≤–∞—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {location})


–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–∏–∞–ª–æ–≥–∞:

–ò–Ω—Ç–µ—Ä–µ—Å—ã: {interests}
–ù–∞–≤—ã–∫–∏: {skills}
–ë—é–¥–∂–µ—Ç: {budget}
–í—Ä–µ–º—è: {time}
–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {location}

–ü–æ–ª–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
{full_conversation}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–ù–∞—á–Ω–∏ —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç–º–æ–¥–∑–∏ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∑–∞—Ç–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ–±–±–∏ —Å–æ–∑–¥–∞–π –±–ª–æ–∫ —Å—Ç—Ä–æ–≥–æ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –≤—ã—à–µ. –ú–µ–∂–¥—É —Ö–æ–±–±–∏ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –∏ —ç–º–æ–¥–∑–∏, –Ω–∏–∫–∞–∫–æ–≥–æ markdown! –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –°–¢–†–û–ì–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
            
            user_interests_summary = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è: {interests}. –í–°–ï —Ö–æ–±–±–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã –∏–º–µ–Ω–Ω–æ —Å —ç—Ç–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–æ–º."
            
            chat_messages = [
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': f'{user_interests_summary}\n\n–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –º–Ω–µ —Å–ø–∏—Å–æ–∫ –∏–∑ 3-7 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ö–æ–±–±–∏, –∫–æ—Ç–æ—Ä—ã–µ –°–¢–†–û–ì–û —Å–≤—è–∑–∞–Ω—ã —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ö–æ–±–±–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º.'}
            ]
            
            response_text = client.get_response_text(chat_messages, temperature=0.9)
            
            if response_text:
                response_text = response_text.replace('###', '').replace('**', '').replace('__', '').replace('---', '').replace('***', '')
                response_text = re.sub(r'\*\*(.*?)\*\*', r'\1', response_text)
                response_text = re.sub(r'__(.*?)__', r'\1', response_text)
            
            messages_history.append({'role': 'assistant', 'content': response_text})
            request.session['test_messages'] = messages_history
            request.session['test_stage'] = 'completed'
            
            return JsonResponse({
                'message': response_text,
                'stage': 'completed'
            })
        
        else:
            return JsonResponse({
                'message': '–¢–µ—Å—Ç —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Å—Ç.',
                'stage': 'completed'
            })
    
    except Exception as e:
        return JsonResponse({'error': f'–û—à–∏–±–∫–∞: {str(e)}'}, status=500)


@login_required
@require_http_methods(["POST"])
def test_reset_view(request):
    request.session['test_messages'] = []
    request.session['test_stage'] = 'collecting'
    request.session['collected_data'] = {
        'interests': '',
        'skills': '',
        'budget': '',
        'time': '',
        'location': ''
    }
    return JsonResponse({'success': True})


@login_required
def community_view(request):
    from django.contrib.auth.models import User
    from django.utils import timezone
    from datetime import timedelta
    
    total_users = User.objects.count()
    recent_users = User.objects.filter(
        date_joined__gte=timezone.now() - timedelta(days=7)
    ).count()
    
    users = User.objects.all().order_by('-date_joined')[:12]
    
    context = {
        'total_users': total_users,
        'recent_users': recent_users,
        'users': users,
    }
    
    return render(request, 'home/community.html', context)

